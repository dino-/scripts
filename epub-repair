#! /bin/bash


case "$1" in
   -h|--help)
      echo "usage: epub-repair.sh ZIPFILE"
      echo "       epub-repair.sh -h"
      echo "       epub-repair.sh --help"
      exit 1
      ;;
esac


if [ "$1" == "" ]
then
   echo "ERROR: No zip file path was supplied"
   exit 1
fi


if [ ! -e "$1" ]
then
   echo "ERROR: File $1 doesn't exist"
   exit 1
fi


# Get the absolute path of the original archive
origPath=$(readlink -f $1)

# Check this archive
unzip -tq $origPath 2>/dev/null > /dev/null

if [ "$?" == "0" ]
then
   echo "$origPath is already a valid zip file"
   exit 0
fi

# Create a temp dir
tmpPath=$(mktemp -d -t epub-repair.XXXX)

# pushd to that dir
pushd $tmpPath

# unpack original archive here with unzip
unzip $origPath

unzipExit=$?
if (( unzipExit >= 3 ))
then
   echo "Error unzipping original file!"
   exit 1
fi

# repack into new archive with zip
newPath="${origPath}-new"
zip -Xr9D $newPath mimetype *

if [ "$?" != "0" ]
then
   echo "Error creating new zip file!"
   exit 1
fi

# If all went well, replace old file with new one
# popd and remove the temp dir
popd
rm -rf $tmpPath
rm $origPath
mv $newPath $origPath


exit 0;
